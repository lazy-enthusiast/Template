<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>福岡 2026 - 獨旅散策</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Shippori+Mincho:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* 福岡主題色：海港深藍 x 明太子紅 */
            --bg-color: #1a2e47;       /* 深藍 (博多灣夜色) */
            --card-color: #F0F2F5;     /* 淺灰白 */
            --accent-color: #E40046;   /* 明太子紅/西鐵紅 */
            --text-on-dark: #FFFFFF;
            --text-on-light: #2F2F2F;
            --menu-bg: #142338;
            --weather-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); /* 清爽的海洋漸層 */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "Noto Sans TC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-on-dark);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- Header --- */
        header {
            padding: 15px 20px;
            background-color: rgba(26, 46, 71, 0.98);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px;
        }
        header h1 { margin: 0; font-size: 1.2rem; font-family: "Shippori Mincho", serif; letter-spacing: 1px; font-weight: bold;}
        
        .header-icons { display: flex; gap: 20px; align-items: center; }
        .header-btn { color: var(--text-on-dark); font-size: 1.2rem; cursor: pointer; text-decoration: none; position: relative;}
        .fan-btn i { color: var(--accent-color); }

        /* --- Global Date Selector --- */
        .date-selector-container {
            background: var(--bg-color); z-index: 90;
            padding: 10px 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            width: 100%;
        }
        .date-selector { 
            display: flex; overflow-x: auto; gap: 10px; padding: 0 20px 5px 20px; 
            scrollbar-width: none; -webkit-overflow-scrolling: touch; justify-content: flex-start;
        }
        @media (min-width: 768px) { .date-selector { justify-content: center; } }
        .date-selector::-webkit-scrollbar { display: none; }
        
        .date-chip {
            background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 16px;
            white-space: nowrap; font-size: 0.85rem; cursor: pointer; color: #aaa;
            display: flex; flex-direction: column; align-items: center; min-width: 55px;
            transition: all 0.2s; border: 1px solid transparent; flex-shrink: 0;
        }
        .date-chip.active {
            background: var(--accent-color); color: #fff;
            box-shadow: 0 0 10px rgba(228, 0, 70, 0.4); transform: scale(1.05);
        }

        /* --- Main Content --- */
        main { flex: 1; overflow-y: hidden; position: relative; }

        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: 10px 0 90px 0;
            display: none; opacity: 0; transition: opacity 0.3s ease;
            background-color: var(--bg-color);
            -webkit-overflow-scrolling: touch;
        }
        .page.active { display: block; opacity: 1; z-index: 10; }
        
        #page-map { padding: 0 0 80px 0; } 
        #map-container { width: 100%; height: 100%; }

        /* 子頁面 */
        .sub-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .sub-page.open { transform: translateX(0); }
        .sub-header {
            padding: 15px 20px; background: var(--menu-bg);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 15px;
        }
        .back-btn { font-size: 1.2rem; color: var(--accent-color); background: none; border: none; padding: 5px; cursor: pointer;}
        .sub-header h2 { margin: 0; font-size: 1.1rem; font-family: "Shippori Mincho", serif; }
        .sub-content { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }

        /* --- Timeline & Cards --- */
        .timeline-container { padding: 0 20px; }
        .timeline-item {
            position: relative; padding-left: 25px; padding-bottom: 30px;
            border-left: 2px solid rgba(228, 0, 70, 0.3);
        }
        .timeline-item:last-child { border-left: 2px solid transparent; padding-bottom: 0; }
        .timeline-item::before {
            content: ''; position: absolute; left: -6px; top: 18px;
            width: 10px; height: 10px; background: var(--accent-color);
            border-radius: 50%; box-shadow: 0 0 0 4px rgba(26, 46, 71, 1);
        }

        .card {
            background-color: var(--card-color); color: var(--text-on-light);
            border-radius: 12px; padding: 16px; margin-bottom: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); cursor: pointer;
            position: relative;
        }
        .card:active { transform: scale(0.98); }
        .card-time { font-size: 0.85rem; color: var(--accent-color); font-weight: 700; display: block; margin-bottom: 6px; }
        .card-title { font-size: 1.1rem; font-weight: 700; margin: 0 0 8px 0; font-family: "Shippori Mincho", serif; line-height: 1.4; padding-right: 10px;}
        .card-price {
            position: absolute; bottom: 12px; right: 15px;
            font-weight: bold; color: #d63345; font-size: 0.9rem;
            background: rgba(255,255,255,0.6); padding: 2px 6px; border-radius: 4px;
        }

        .tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 5px; max-width: 70%; }
        .card-tag { font-size: 0.7rem; background: #D0D0D0; padding: 3px 8px; border-radius: 4px; color: #444; }
        .card-tag.highlight { background: #ffe4e6; color: #d63345; border: 1px solid #fab1b8; }
        .card-tag.tips { background: #e0f2fe; color: #0369a1; }
        .card-tag.alert { background: #fee2e2; color: #b91c1c; border: 1px solid #f87171; font-weight: bold;}

        /* --- Weather Styles --- */
        .weather-card {
            background: var(--weather-gradient);
            border-radius: 16px; padding: 25px; margin: 20px;
            text-align: center; color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .weather-main { display: flex; justify-content: space-around; align-items: center; margin: 20px 0; }
        .weather-icon { font-size: 3.5rem; }
        .weather-temp { font-size: 3rem; font-weight: 300; }
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; }
        .w-item { font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }

        /* --- Shopping Styles --- */
        .shopping-section-title { font-family: "Shippori Mincho", serif; margin: 0 0 10px 0; color: var(--accent-color); border-bottom: 1px solid #555; padding-bottom: 5px;}
        .shopping-group { margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; }

        /* --- Tools Grid --- */
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
        .tool-btn {
            background: rgba(255,255,255,0.08); padding: 25px 15px;
            border-radius: 16px; text-align: center;
            border: 1px solid rgba(255,255,255,0.05); cursor: pointer;
        }
        .tool-btn i { font-size: 2.2rem; color: var(--accent-color); margin-bottom: 12px; display: block; }

        /* --- Lists --- */
        .checklist-item {
            background: rgba(255,255,255,0.08); padding: 15px; margin-bottom: 12px;
            border-radius: 8px; display: flex; align-items: center; gap: 15px;
        }
        .checklist-item.checked { opacity: 0.5; }
        .checklist-item.checked span { text-decoration: line-through; }
        .checklist-item input { width: 22px; height: 22px; accent-color: var(--accent-color); }
        
        /* --- Footer --- */
        nav.bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            background-color: var(--menu-bg);
            display: flex; justify-content: space-around;
            padding: 10px 0 25px 0; border-top: 1px solid rgba(255,255,255,0.1); z-index: 100;
        }
        .nav-item { color: #888; text-align: center; font-size: 0.75rem; cursor: pointer; width: 25%; }
        .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent-color); }

        /* --- Modal --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000;
            justify-content: center; align-items: end; backdrop-filter: blur(3px);
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--card-color); color: var(--text-on-light);
            width: 100%; max-width: 600px; max-height: 85vh;
            border-radius: 20px 20px 0 0; padding: 25px;
            overflow-y: auto; animation: slideUp 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.8rem; color: #888; cursor: pointer; }
        
        .info-row { margin: 12px 0; display: flex; align-items: flex-start; gap: 12px; font-size: 0.95rem; line-height: 1.6; }
        .info-row i { color: var(--accent-color); margin-top: 4px; width: 20px; text-align: center; }
        .note-box {
            background: #f8f8f8; border-left: 4px solid var(--accent-color);
            padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0;
            font-size: 0.95rem; color: #333; line-height: 1.7;
        }
        .link-btn {
            display: inline-block; background: #eee; color: #333; 
            padding: 6px 12px; border-radius: 4px; text-decoration: none; 
            font-size: 0.85rem; margin-top: 5px; border: 1px solid #ccc;
        }
        .action-btn {
            display: flex; justify-content: center; align-items: center; gap: 8px;
            width: 100%; padding: 14px; margin-top: 20px;
            background: var(--accent-color); color: white;
            text-decoration: none; border-radius: 10px;
            font-weight: bold; font-size: 1rem; border: none; cursor: pointer;
        }
        
        /* Taxi Card */
        .taxi-card {
            background: #fff; color: #000; padding: 20px; 
            border: 4px solid #000; margin: 15px 0; 
            text-align: center; border-radius: 8px;
        }

        /* Talk Card Styles */
        .talk-card {
            background: #fff; color: #333;
            border-radius: 12px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-align: center;
        }
        .talk-jp { font-size: 1.4rem; font-weight: bold; margin-bottom: 8px; color: var(--text-on-light); }
        .talk-zh { font-size: 0.9rem; color: #666; }

    </style>
</head>
<body>

    <header>
        <h1>FUKUOKA 2026</h1>
        <div class="header-icons">
            <a href="googletranslate://" class="header-btn" title="Google Translate">
                <i class="fa-solid fa-language"></i>
            </a>
            <a href="#" class="header-btn fan-btn" onclick="openToolsPage(); return false;">
                <i class="fa-solid fa-plane-arrival"></i>
            </a>
        </div>
    </header>

    <div class="date-selector-container">
        <div class="date-selector" id="date-selector"></div>
    </div>

    <main>
        <div id="page-itinerary" class="page active">
            <div class="timeline-container" id="timeline-container" style="padding-top: 20px;"></div>
            <div style="text-align:center; color:#888; font-size:0.8rem; margin:30px 0;">博多美食 • 滿載而歸</div>
        </div>

        <div id="page-map" class="page">
            <div id="map-container"></div>
            <div style="position:absolute; bottom:90px; left:10px; background:rgba(255,255,255,0.9); padding:8px 12px; border-radius:8px; color:#333; font-size:0.8rem; box-shadow:0 2px 5px rgba(0,0,0,0.3); pointer-events:none; z-index:999;">
                <i class="fa-solid fa-location-dot" style="color:var(--accent-color)"></i> 顯示當日行程地點
            </div>
        </div>

        <div id="page-weather" class="page">
            <div style="padding: 20px;">
                <h2 style="font-family:'Shippori Mincho',serif; text-align:center; margin-bottom:10px;">當日天氣預報</h2>
                <div id="weather-content"></div>
                
                <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:12px; margin:20px 0; display:flex; align-items:center; justify-content:space-between; border:1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight:bold; color:var(--accent-color);"><i class="fa-solid fa-glass-water"></i> 水分補給 Check</div>
                        <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;">喝酒/溫泉後請補水</div>
                    </div>
                    <div style="display:flex; gap:15px; align-items:center;">
                        <button onclick="addWater()" style="background:var(--accent-color); border:none; color:white; width:45px; height:45px; border-radius:50%; font-size:1.2rem; cursor:pointer;"><i class="fa-solid fa-plus"></i></button>
                        <span id="water-count" style="font-size:2rem; font-family:'Shippori Mincho',serif; min-width:30px; text-align:center;">0</span>
                    </div>
                </div>

                <div class="note-box">
                    <div style="font-weight:bold; margin-bottom:5px; color:var(--accent-color);">福岡氣候 TIPS：</div>
                    福岡屬海港城市，風較大。<br>
                    夏季悶熱程度略低於京都，但陽光強烈。<br>
                    若去海邊（糸島/海之中道）請注意防風防曬。
                </div>
            </div>
        </div>

        <div id="page-shopping" class="page">
            <div style="padding: 20px;">
                <h2 style="font-family:'Shippori Mincho',serif; text-align:center;">今日購物建議</h2>
                <p style="text-align:center; opacity:0.7; font-size:0.85rem; margin-bottom:20px;">根據當日行程地點推薦</p>
                
                <div id="daily-shopping-list"></div>

                <div style="margin-top:40px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                    <h3 style="color:#aaa; font-size:1rem;">福岡必買清單 (General)</h3>
                    <div id="general-shopping-container"></div>
                </div>
            </div>
        </div>

        <div id="page-tools" class="page">
            <h2 style="text-align:center; margin: 30px 0 20px 0; font-family:'Shippori Mincho',serif;">旅人百寶箱</h2>
            <div class="tools-grid">
                <div class="tool-btn" onclick="openSubPage('hotel')">
                    <i class="fa-solid fa-bed"></i><span>酒店資訊</span>
                </div>
                <div class="tool-btn" onclick="openSubPage('packing')">
                    <i class="fa-solid fa-suitcase"></i><span>行李清單</span>
                </div>
                <div class="tool-btn" onclick="openSubPage('rate')">
                    <i class="fa-solid fa-yen-sign"></i><span>匯率換算</span>
                </div>
                <div class="tool-btn" onclick="openSubPage('safety')">
                    <i class="fa-solid fa-user-shield"></i><span>安全報平安</span>
                </div>
                <div class="tool-btn" onclick="openSubPage('talk')">
                    <i class="fa-solid fa-comment-dots"></i><span>手指對話</span>
                </div>
                <div class="tool-btn" onclick="openTipsModal()">
                    <i class="fa-regular fa-compass"></i><span>路痴救星</span>
                </div>
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button onclick="history.back()" style="background:none; border:1px solid #777; color:#fff; padding:10px 20px; border-radius:20px;">關閉百寶箱</button>
            </div>
        </div>

        <div id="subpage-hotel" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('hotel')"><i class="fa-solid fa-arrow-left"></i></button><h2>酒店資訊</h2></div>
            <div class="sub-content">
                <h3 style="color:var(--accent-color); font-family:'Shippori Mincho',serif; margin-bottom:10px;">[待定] Fukuoka Hotel</h3>
                <div style="font-size:0.9rem; opacity:0.8; margin-bottom:20px;">福岡酒店預留位</div>
                
                <div class="note-box">
                    <i class="fa-solid fa-location-dot" style="color:var(--accent-color)"></i> <b>地址：</b><br>
                    待確認地址...<br>
                    <span style="font-size:0.8rem; color:#666;">(Waiting for update)</span><br>
                </div>

                <div class="checklist-item" style="opacity:1;">
                    <i class="fa-regular fa-clock" style="color:var(--accent-color)"></i> 
                    <span><b>Check-in:</b> 15:00 / <b>Out:</b> 11:00</span>
                </div>
            </div>
        </div>

        <div id="subpage-packing" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('packing')"><i class="fa-solid fa-arrow-left"></i></button><h2>行李清單</h2></div>
            <div class="sub-content" id="packing-list-container"></div>
        </div>
        
        <div id="subpage-rate" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('rate')"><i class="fa-solid fa-arrow-left"></i></button><h2>匯率換算</h2></div>
            <div class="sub-content" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:80%;">
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; width:100%;">
                    <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                         <label style="font-size:0.8rem; color:#aaa;">匯率: <input type="number" id="rate-setting" value="0.052" step="0.001" style="width:60px; background:transparent; color:#fff; border:1px solid #555; text-align:center; border-radius:4px;"></label>
                    </div>
                    <label>日幣 (JPY)</label><input type="number" id="jpy-input" placeholder="¥" oninput="calcRate('jpy')" style="width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; border-radius: 8px; text-align: center;">
                    <div style="text-align:center; font-size:1.5rem; margin:10px 0; color:var(--accent-color);">⇅</div>
                    <label>港幣 (HKD)</label><input type="number" id="hkd-input" placeholder="$" oninput="calcRate('hkd')" style="width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; border-radius: 8px; text-align: center;">
                </div>
            </div>
        </div>
        
        <div id="subpage-safety" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('safety')"><i class="fa-solid fa-arrow-left"></i></button><h2>安全功能</h2></div>
            <div class="sub-content">
                <div style="text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #128c7e, #075e54); border-radius: 16px; margin-bottom: 20px;" onclick="sendSafetyMessage()">
                    <i class="fa-brands fa-whatsapp" style="font-size:3rem; color:white; margin-bottom:15px;"></i>
                    <h3 style="margin:0 0 10px 0;">一鍵報平安 (WhatsApp)</h3>
                    <p style="opacity:0.8; margin:0;">按此發送位置給家人</p>
                </div>
                <h3 style="border-bottom:1px solid #555; padding-bottom:10px; margin-top:30px;">緊急資訊</h3>
                <div class="checklist-item" onclick="alert('110')"><i class="fa-solid fa-shield-halved" style="color:var(--accent-color);"></i><span>警察局: 110</span></div>
                <div class="checklist-item" onclick="alert('119')"><i class="fa-solid fa-truck-medical" style="color:var(--accent-color);"></i><span>救護/消防: 119</span></div>
                <div class="note-box">
                    <b>中洲地區注意：</b><br>
                    晚上在中洲（Nakasu）歡樂街，尤其是獨行時，請避免跟隨拉客的人（Tout），只去目標明確的餐廳或屋台。
                </div>
            </div>
        </div>

        <div id="subpage-talk" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('talk')"><i class="fa-solid fa-arrow-left"></i></button><h2>手指指對話</h2></div>
            <div class="sub-content">
                <div class="talk-card">
                    <div class="talk-jp">一人です。</div>
                    <div class="talk-zh">我是一位。</div>
                </div>
                <div class="talk-card">
                    <div class="talk-jp">おすすめは何ですか？</div>
                    <div class="talk-zh">有推薦的菜色嗎？</div>
                </div>
                <div class="talk-card">
                    <div class="talk-jp">クレジットカードは<br>使えますか？</div>
                    <div class="talk-zh">可以用信用卡嗎？(屋台多為現金)</div>
                </div>
                <div class="talk-card">
                    <div class="talk-jp">替え玉をお願いします。</div>
                    <div class="talk-zh">(拉麵) 請幫我加麵。</div>
                </div>
                <div class="talk-card">
                    <div class="talk-jp">豚骨ラーメンの匂いが...</div>
                    <div class="talk-zh">豚骨拉麵的味道好濃啊...</div>
                </div>
            </div>
        </div>

    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchMainPage('itinerary', this)"><i class="fa-solid fa-calendar-days"></i> 行程</div>
        <div class="nav-item" onclick="switchMainPage('map', this)"><i class="fa-solid fa-map-location-dot"></i> 地圖</div>
        <div class="nav-item" onclick="switchMainPage('weather', this)"><i class="fa-solid fa-cloud-sun-rain"></i> 天氣</div>
        <div class="nav-item" onclick="switchMainPage('shopping', this)"><i class="fa-solid fa-basket-shopping"></i> 購物</div>
    </nav>

    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">×</span>
            <div class="modal-header"><h2 id="modal-title">標題</h2><span id="modal-type" class="sub">類型</span></div>
            <div class="modal-body">
                
                <div id="taxi-card" class="taxi-card" style="display:none;">
                    <p style="font-size:0.8rem; color:#666; margin:0 0 5px 0;">運転手さん、ここへお願いします</p>
                    <h2 id="taxi-address" style="font-size:1.5rem; margin:5px 0; font-weight:bold; line-height:1.2;"></h2>
                    <p id="taxi-name" style="font-size:1rem; margin-top:5px; color:#444;"></p>
                </div>

                <div class="info-row"><i class="fa-regular fa-clock"></i><span id="modal-time">時間</span></div>
                <div class="info-row"><i class="fa-solid fa-location-dot"></i><span id="modal-address">地址</span></div>
                <div class="info-row" id="modal-price-row"><i class="fa-solid fa-money-bill-wave"></i><span id="modal-price"></span></div>
                
                <div class="info-row" style="background:rgba(228,0,70,0.1); padding:8px; border-radius:6px; align-items:center;">
                    <i class="fa-solid fa-calculator"></i>
                    <span style="white-space:nowrap;">實際花費(¥)：</span>
                    <input type="number" id="modal-actual-cost" placeholder="0" style="background:transparent; border:none; border-bottom:1px solid #555; width:80px; color:#333; font-size:1rem; text-align:center;" onchange="saveExpense()">
                </div>

                <div class="note-box">
                    <div style="font-weight:bold; margin-bottom:8px; color:var(--accent-color);">攻略與 TIPS：</div>
                    <span id="modal-note">內容...</span>
                </div>
                <div id="modal-links" style="margin-bottom: 20px;"></div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                     <button class="action-btn" id="modal-map-btn" style="margin-top:0;"><i class="fa-solid fa-map-location-dot"></i> Google 導航</button>
                     <button class="action-btn" onclick="toggleTaxiCard()" style="margin-top:0; background:#444;"><i class="fa-solid fa-taxi"></i> 給司機看</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==========================================
        //  待更新區域：收到行程表後，我會幫你更新這裡
        // ==========================================
        const scheduleData = {
            "day1": {
                "date": "Day 1 (範本)",
                "events": [
                    { 
                        time: "14:00", 
                        title: "抵達福岡機場", 
                        type: "交通", 
                        price: "¥260", 
                        address: "Fukuoka Airport", 
                        coords: [33.5859, 130.4446], 
                        note: "<b>超方便：</b>國內線航廈搭地鐵，5分鐘到博多，11分鐘到天神。<br>信用卡(Visa/Master)可直接刷卡進閘。", 
                        tags: ["移動", "地鐵"], 
                        shopping_items: ["ICOCA (若無)", "便利商店水"] 
                    },
                    { 
                        time: "晚上", 
                        title: "中洲/天神 屋台體驗", 
                        type: "美食", 
                        price: "¥2,000", 
                        address: "Nakasu / Tenjin", 
                        coords: [33.5925, 130.4080], 
                        note: "<b>攻略：</b>通常只收現金。先問價格再入座。<br>推薦：烤拉麵、明太子玉子燒。", 
                        tags: ["美食", "屋台"],
                        shopping_items: []
                    }
                ]
            }
            // 稍後加入 Day2, Day3...
        };

        const packingList = ["護照", "ICOCA/Suica", "行動電源", "雨具", "防曬/防風外套", "好走的鞋", "常備藥", "網卡"];
        // 福岡特產清單
        const generalShoppingListItems = ["明太子 (Fukuya/Yamaya)", "博多通饅頭 (Torimon)", "努努雞 (冷吃炸雞)", "Menbei (明太仙貝)", "茅乃舍高湯包", "柚子胡椒", "一蘭/一風堂 泡麵禮盒", "八女茶"];

        let currentDay = "day1";
        let map = null;
        let markers = [];
        let waterCount = 0;
        let currentModalEventTitle = ""; 
        const STORAGE_KEY = 'fukuoka_2026_data_v1';

        // --- Logic ---
        function init() { 
            renderDateSelector(); 
            renderPackingList();
            renderGeneralShoppingList();
            initMap();
            loadState(); 
            
            // 預設選取第一天
            const chips = document.querySelectorAll('.date-chip');
            if(chips.length > 0) selectDay('day1', chips[0]);
        }

        // --- Data Persistence ---
        function saveState() {
            const state = {
                checks: {},
                water: waterCount,
                expenses: {}
            };
            document.querySelectorAll('input[type="checkbox"]').forEach(input => {
                if(input.id) state.checks[input.id] = input.checked;
            });
            
            const savedRaw = localStorage.getItem(STORAGE_KEY);
            let savedExpenses = {};
            if(savedRaw) {
                try { savedExpenses = JSON.parse(savedRaw).expenses || {}; } catch(e){}
            }
            state.expenses = savedExpenses;
            
            const costInput = document.getElementById('modal-actual-cost');
            if(costInput && currentModalEventTitle) {
                state.expenses[currentModalEventTitle] = costInput.value;
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;
            try {
                const state = JSON.parse(saved);
                if (typeof state.water === 'number') {
                    waterCount = state.water;
                    const wc = document.getElementById('water-count');
                    if(wc) wc.innerText = waterCount;
                }
                setTimeout(() => {
                    Object.keys(state.checks).forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.checked = state.checks[id];
                            if(el.parentElement.classList.contains('checklist-item')) {
                                el.parentElement.classList.toggle('checked', el.checked);
                            }
                        }
                    });
                }, 100);
            } catch (e) { console.error("Load failed", e); }
        }
        
        function saveExpense() { saveState(); }

        function getSavedExpense(title) {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return "";
            try {
                const state = JSON.parse(saved);
                return state.expenses && state.expenses[title] ? state.expenses[title] : "";
            } catch(e) { return ""; }
        }

        function switchMainPage(pageId, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(navEl) {
                navEl.classList.add('active');
            } else {
                const idx = ['itinerary', 'map', 'weather', 'shopping'].indexOf(pageId);
                if(idx !== -1) document.querySelectorAll('.nav-item')[idx].classList.add('active');
            }

            if(pageId === 'map' && map) {
                setTimeout(() => { map.invalidateSize(); fitMapToDay(); }, 200);
            }
        }

        function openToolsPage() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-tools').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        }

        function openSubPage(id) { document.getElementById('subpage-' + id).classList.add('open'); }
        function closeSubPage(id) { document.getElementById('subpage-' + id).classList.remove('open'); }

        function renderDateSelector() {
            const container = document.getElementById('date-selector'); container.innerHTML = '';
            Object.keys(scheduleData).forEach(dayKey => {
                const dayInfo = scheduleData[dayKey];
                const dayNum = dayKey.replace('day', '');
                const chip = document.createElement('div');
                chip.className = `date-chip`;
                chip.onclick = () => selectDay(dayKey, chip);
                chip.innerHTML = `<span class="day-num">D${dayNum}</span><span class="day-week">${dayInfo.date.split(' ')[0]}</span>`;
                container.appendChild(chip);
            });
        }

        function selectDay(dayKey, chipEl) {
            currentDay = dayKey;
            document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
            if(chipEl) chipEl.classList.add('active');
            
            renderTimeline(dayKey);
            renderWeather(dayKey);
            renderDailyShopping(dayKey);
            if(map) updateMapMarkers(dayKey);
            loadState(); 
        }

        function renderTimeline(dayKey) {
            const container = document.getElementById('timeline-container'); container.innerHTML = '';
            const dayTitle = document.createElement('h3'); dayTitle.style.marginBottom='20px';
            dayTitle.innerHTML = `<span style="color:var(--accent-color); font-family:'Shippori Mincho',serif;">${scheduleData[dayKey].date}</span>`;
            container.appendChild(dayTitle);

            scheduleData[dayKey].events.forEach(event => {
                const item = document.createElement('div'); item.className = 'timeline-item';
                let tagsHtml = event.tags.map(t => {
                    let c = 'card-tag'; 
                    if(t.includes('必')||t.includes('路痴')||t.includes('攻略')) c+=' highlight';
                    return `<span class="${c}">${t}</span>`;
                }).join('');
                
                let priceHtml = event.price ? `<div class="card-price">${event.price}</div>` : '';

                item.innerHTML = `<div class="card" onclick='openEventModal(${JSON.stringify(event).replace(/'/g, "'")})'>
                    <span class="card-time">${event.time}</span>
                    <h3 class="card-title">${event.title}</h3>
                    <div class="tags">${tagsHtml}</div>
                    ${priceHtml}
                </div>`;
                container.appendChild(item);
            });
        }

        function renderWeather(dayKey) {
            const container = document.getElementById('weather-content');
            // 簡易模擬：假設夏季，可根據實際月份調整
            const temp = 32;
            const humidity = 75;
            
            container.innerHTML = `
                <div class="weather-card">
                    <div style="font-size:0.9rem; opacity:0.9;">${scheduleData[dayKey].date} • 福岡</div>
                    <div class="weather-main">
                        <div class="weather-icon"><i class="fa-solid fa-cloud-sun"></i></div>
                        <div class="weather-temp">${temp}°C</div>
                    </div>
                    <div style="font-size:1.2rem; margin-bottom:15px;">多雲/海風</div>
                    <div class="weather-grid">
                        <div class="w-item"><i class="fa-solid fa-droplet"></i> 濕度 ${humidity}%</div>
                        <div class="w-item"><i class="fa-solid fa-umbrella"></i> 降雨 20%</div>
                        <div class="w-item"><i class="fa-solid fa-wind"></i> 風速 4級</div>
                        <div class="w-item"><i class="fa-solid fa-temperature-arrow-up"></i> 體感 ${temp+3}°</div>
                    </div>
                </div>
            `;
        }
        
        function addWater() {
            waterCount++;
            document.getElementById('water-count').innerText = waterCount;
            saveState();
        }

        function renderDailyShopping(dayKey) {
            const container = document.getElementById('daily-shopping-list');
            container.innerHTML = '';
            const events = scheduleData[dayKey].events;
            let hasItems = false;

            events.forEach(event => {
                if (event.shopping_items && event.shopping_items.length > 0) {
                    hasItems = true;
                    const group = document.createElement('div');
                    group.className = 'shopping-group';
                    let itemsHtml = '';
                    event.shopping_items.forEach((item, i) => {
                        const id = `shop-${dayKey}-${event.title}-${i}`.replace(/\s+/g, '');
                        itemsHtml += `<div class="checklist-item" onclick="toggleCheck(this)">
                            <input type="checkbox" id="${id}">
                            <label for="${id}"><span>${item}</span></label>
                        </div>`;
                    });
                    group.innerHTML = `<h4 class="shopping-section-title"><i class="fa-solid fa-location-dot"></i> ${event.title}</h4>${itemsHtml}`;
                    container.appendChild(group);
                }
            });

            if (!hasItems) {
                container.innerHTML = `<div style="text-align:center; padding:30px; opacity:0.5;">
                    <i class="fa-solid fa-bag-shopping" style="font-size:2rem; margin-bottom:10px;"></i><br>
                    本日以散策/美食為主
                </div>`;
            }
        }

        function renderGeneralShoppingList() {
            const container = document.getElementById('general-shopping-container');
            generalShoppingListItems.forEach((item,i) => {
                container.innerHTML += `<div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" id="g${i}"><label for="g${i}"><span>${item}</span></label></div>`;
            });
        }

        function renderPackingList() {
            const pC = document.getElementById('packing-list-container');
            pC.innerHTML = '';
            packingList.forEach((item,i) => pC.innerHTML += `<div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" id="p${i}"><label for="p${i}"><span>${item}</span></label></div>`);
        }
        
        function toggleCheck(el) { 
            const i = el.querySelector('input'); 
            if(event.target !== i) { i.checked = !i.checked; }
            el.classList.toggle('checked', i.checked); 
            saveState();
        }

        function calcRate(type) {
            const rate = parseFloat(document.getElementById('rate-setting').value) || 0.052;
            const jpy = document.getElementById('jpy-input'); 
            const hkd = document.getElementById('hkd-input');
            
            if(type==='jpy') {
                if(jpy.value === '') hkd.value = '';
                else hkd.value = (jpy.value * rate).toFixed(1); 
            } else {
                if(hkd.value === '') jpy.value = '';
                else jpy.value = (hkd.value / rate).toFixed(0);
            }
        }

        function sendSafetyMessage() {
             if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    const link = `https://www.google.com/maps/search/?api=1&query=${pos.coords.latitude},${pos.coords.longitude}`;
                    window.open(`https://wa.me/?text=${encodeURIComponent("Hello! 我在福岡一切安好，目前位置：" + link)}`, '_blank');
                });
            } else alert("無法獲取定位");
        }

        function openEventModal(event) {
            currentModalEventTitle = event.title;
            
            document.getElementById('modal-title').innerText = event.title;
            document.getElementById('modal-type').innerText = event.type;
            document.getElementById('modal-time').innerText = event.time;
            document.getElementById('modal-address').innerText = event.address;
            document.getElementById('modal-note').innerHTML = event.note;
            
            document.getElementById('modal-actual-cost').value = getSavedExpense(event.title);
            
            document.getElementById('taxi-address').innerText = event.address;
            document.getElementById('taxi-name').innerText = event.title;
            document.getElementById('taxi-card').style.display = 'none';

            const priceRow = document.getElementById('modal-price-row');
            if (event.price) {
                priceRow.style.display = 'flex';
                document.getElementById('modal-price').innerText = "預算：" + event.price;
            } else {
                priceRow.style.display = 'none';
            }

            const lc = document.getElementById('modal-links'); lc.innerHTML = '';
            if(event.link) lc.innerHTML = `<a href="${event.link}" target="_blank" class="link-btn"><i class="fa-solid fa-link"></i> 預約/詳情</a>`;
            
            let mapUrl = "";
            if(event.coords) {
                mapUrl = `https://www.google.com/maps/search/?api=1&query=${event.coords[0]},${event.coords[1]}`;
            } else {
                const q = encodeURIComponent(event.address + " " + event.title);
                mapUrl = `https://www.google.com/maps/search/?api=1&query=${q}`;
            }
            document.getElementById('modal-map-btn').onclick = () => window.open(mapUrl, '_blank');
            document.getElementById('detail-modal').classList.add('open');
        }
        
        function toggleTaxiCard() {
            const card = document.getElementById('taxi-card');
            card.style.display = card.style.display === 'none' ? 'block' : 'none';
        }

        function closeModal() { 
            document.getElementById('detail-modal').classList.remove('open'); 
            currentModalEventTitle = ""; 
        }
        document.getElementById('detail-modal').addEventListener('click', function(e){if(e.target===this)closeModal()});
        
        // 更新：福岡路痴 TIPS
        function openTipsModal() { openEventModal({title:"路痴救星 (福岡版)",type:"TIPS",time:"隨時",address:"福岡全區",note:"1. <b>地下鐵</b>最簡單，有「信用卡感應」標示可直接刷Visa/Master進站。<br>2. <b>天神地下街</b> 容易迷路，記得看地板號碼（1-12號街）。<br>3. <b>巴士</b>：後門上車抽整理券，前門付錢。<br>4. 博多站有兩個出口：<b>博多口</b> (熱鬧/巴士站)、<b>筑紫口</b> (新幹線/居酒屋)。", tags:[]}); }

        // --- Map Logic ---
        function initMap() {
            map = L.map('map-container');
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap' }).addTo(map);
            // 預設視野：博多站
            map.setView([33.590188, 130.420685], 13);
            updateMapMarkers(currentDay);
        }

        function updateMapMarkers(dayKey) {
            if(!map) return;
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            const events = scheduleData[dayKey].events;
            const group = new L.featureGroup();

            events.forEach(event => {
                if(event.coords) {
                    const navUrl = `https://www.google.com/maps/search/?api=1&query=${event.coords[0]},${event.coords[1]}`;
                    const popupContent = `
                        <div style="text-align:center">
                            <b>${event.title}</b><br>${event.time}<br>
                            <a href="${navUrl}" target="_blank" style="display:inline-block; margin-top:5px; color:#E40046; text-decoration:none; font-weight:bold;">
                                <i class="fa-solid fa-location-arrow"></i> 導航
                            </a>
                        </div>
                    `;
                    const m = L.marker(event.coords).addTo(map).bindPopup(popupContent);
                    markers.push(m);
                    group.addLayer(m);
                }
            });

            if(markers.length > 0) {
                map.fitBounds(group.getBounds(), {padding: [50, 50]});
            } else {
                // 若無座標，預設看博多
                map.setView([33.590188, 130.420685], 13);
            }
        }
        
        function fitMapToDay() {
            if(map && markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds(), {padding: [50, 50]});
            }
        }

        init();
    </script>
</body>
</html>
